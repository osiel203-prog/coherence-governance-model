<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coherence Index (CI) Calculator & CR-90 Portal</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Use Inter Font -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
        }
        /* Custom scrollbar for aesthetic purposes */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #4f46e5; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #3730a3; }
    </style>
</head>
<body class="p-4 sm:p-8">

    <div id="app" class="max-w-4xl mx-auto space-y-10">

        <!-- Header and Main Title -->
        <header class="text-center space-y-2 py-4 border-b border-indigo-200">
            <h1 class="text-4xl font-extrabold text-indigo-700">Coherence Index (CI) Calculator</h1>
            <p class="text-lg text-gray-600">The Structural Imperative: Quantifying Systemic Stress</p>
        </header>

        <!-- Live CI Result Card -->
        <div id="ci-result-card" class="bg-white p-6 rounded-xl shadow-2xl border-b-4 border-indigo-500 transition-all duration-300">
            <div class="flex flex-col sm:flex-row items-center justify-between">
                <div class="flex items-center space-x-3">
                    <svg class="w-8 h-8 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l2-2 2 2v13M9 19H7a2 2 0 01-2-2v-5a2 2 0 012-2h2m0 0h6m-6 0h6m-6 0v2m0 4v2m0 4v2m0 0h2a2 2 0 002-2v-5a2 2 0 00-2-2h-2m-6 0H9m-6 0h6"></path></svg>
                    <p class="text-xl font-semibold text-gray-700">Calculated Coherence Index (CI):</p>
                </div>
                <div class="mt-4 sm:mt-0">
                    <span id="ci-output" class="text-5xl font-extrabold text-indigo-700">0.000</span>
                </div>
            </div>
            <p id="ci-status" class="mt-4 text-center text-sm font-medium p-2 rounded-lg"></p>
        </div>

        <!-- The Five Axioms (Inputs) -->
        <section class="bg-white p-6 rounded-xl shadow-lg">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">The Five Axioms (Inputs)</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6" id="input-container">
                <!-- Input fields will be generated by JS -->
            </div>
            <p class="mt-6 text-sm text-gray-500">
                Capacity (C) is normalized to **1.00**. All other values are input as proportions (0.00 to 1.00) or multipliers (1.00+).
            </p>
        </section>

        <!-- CR-90 Data Submission -->
        <section class="bg-indigo-50 p-6 rounded-xl shadow-lg border-2 border-indigo-300">
            <h2 class="text-2xl font-bold text-indigo-700 mb-6">CR-90 Data Submission</h2>

            <div class="mb-4">
                <label for="project-description" class="block text-sm font-medium text-gray-700 mb-1">Project Type/Description</label>
                <input type="text" id="project-description" placeholder="e.g., Q2 Feature Launch, Marketing Ops, Scrum Team X" class="w-full p-3 border border-indigo-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 shadow-sm" required>
            </div>

            <button onclick="submitData()" id="submit-btn" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700 transition-all duration-200 shadow-md shadow-indigo-400/50 flex items-center justify-center space-x-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                <span>Calculate & Submit Data for CR-90</span>
            </button>
            <p id="message-box" class="mt-4 text-center text-sm font-medium text-red-600"></p>
        </section>

        <!-- Documentation Links - THIS SECTION HAS BEEN UPDATED WITH PLACEHOLDERS -->
        <section class="bg-gray-100 p-6 rounded-xl shadow-inner">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Documentation & Resources (Update These Links!)</h2>
            <p class="text-gray-600 mb-4">
                **IMPORTANT:** These links must be updated with the **Raw GitHub URLs** after you upload the PDF documents.
                See the instructions in the chat for how to generate these public links.
            </p>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <a id="link-paper" href="[REPLACE_WITH_YOUR_GITHUB_RAW_URL]/Structural_Governance_Paper.pdf" target="_blank" class="flex items-center space-x-3 p-3 bg-white rounded-lg shadow hover:shadow-md transition duration-150">
                    <svg class="w-6 h-6 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m-6 4h6"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 21h4a2 2 0 002-2V5a2 2 0 00-2-2h-4a2 2 0 00-2 2v14a2 2 0 002 2z"></path></svg>
                    <span class="text-gray-700 font-medium">Structural Governance Paper (Theory)</span>
                </a>
                <a id="link-guide" href="[REPLACE_WITH_YOUR_GITHUB_RAW_URL]/CGM_User_Guide.pdf" target="_blank" class="flex items-center space-x-3 p-3 bg-white rounded-lg shadow hover:shadow-md transition duration-150">
                    <svg class="w-6 h-6 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.832 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.832 5 16.5 5s3.332.477 4.5 1.253v13C19.832 18.477 18.168 18 16.5 18s-3.332.477-4.5 1.253"></path></svg>
                    <span class="text-gray-700 font-medium">CGM User Guide (Estimation Protocol)</span>
                </a>
            </div>
        </section>

        <!-- Recent CR-90 Submissions (The Public Data Repository) -->
        <section class="bg-white p-6 rounded-xl shadow-lg">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">Recent CR-90 Submissions (Live Data)</h2>
            <p class="text-gray-600 mb-4">View the live dataset being collected for the Coherence Rollup (CR-90) initiative. Data is stored in the public Firestore collection.</p>

            <div class="overflow-x-auto rounded-lg border border-gray-200 shadow-inner">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Project</th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">CI</th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">S</th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">D</th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">T</th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">V</th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Submitter ID</th>
                        </tr>
                    </thead>
                    <tbody id="submissions-table-body" class="bg-white divide-y divide-gray-200">
                        <tr><td colspan="7" class="px-3 py-4 text-sm text-gray-500 text-center">Loading submissions...</td></tr>
                    </tbody>
                </table>
            </div>
        </section>

    </div>

    <!-- Firebase Imports and Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, onSnapshot, collection, query, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // IMPORTANT: Global variables provided by the Canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db, auth;
        let userId = null;
        let isAuthReady = false;

        // --- Core Data & Definitions ---
        const AXIOM_FIELDS = [
            { id: 'S', label: 'Scope (S)', placeholder: 'Committed Workload % (e.g., 0.80)', default: 0.80, min: 0.00, step: 0.01, tip: 'Committed workload as a proportion of total capacity (C). High S reduces headroom.' },
            { id: 'D', label: 'Drift (D)', placeholder: 'Frictional Cost Multiplier (e.g., 0.15)', default: 0.15, min: 0.00, step: 0.01, tip: 'Non-productive friction (meetings, debt, tools). Input as a multiplier (15% waste = 0.15).' },
            { id: 'T', label: 'Tension (T)', placeholder: 'Immediacy Multiplier (e.g., 0.05)', default: 0.05, min: 0.00, step: 0.01, tip: 'Pressure from urgent demands/context-switching. Input as a multiplier (5% urgency = 0.05).' },
            { id: 'V', label: 'Volatility (V)', placeholder: 'Strategic Reserve Tax (e.g., 0.10)', default: 0.10, min: 0.00, step: 0.01, tip: 'Capacity reserved for systemic risk (turnover, unknowns). Input as a proportion of C.' },
        ];
        const C = 1.00; // Capacity (C) is always normalized to 1.00

        // --- UI Setup ---

        function createInputHTML(axiom) {
            return `
                <div class="space-y-1">
                    <label for="${axiom.id}" class="block text-sm font-medium text-gray-700">${axiom.label}</label>
                    <input type="number" id="${axiom.id}" value="${axiom.default}" min="${axiom.min}" step="${axiom.step}"
                        class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 shadow-sm"
                        placeholder="${axiom.placeholder}"
                        oninput="window.updateCI()"
                    >
                    <p class="text-xs text-gray-500">${axiom.tip}</p>
                </div>
            `;
        }

        function renderInputs() {
            const container = document.getElementById('input-container');
            if (container) {
                container.innerHTML = AXIOM_FIELDS.map(createInputHTML).join('');
            }
        }

        // --- Core Calculation Logic ---

        window.updateCI = function() {
            const S = parseFloat(document.getElementById('S')?.value) || 0;
            const D = parseFloat(document.getElementById('D')?.value) || 0;
            const T = parseFloat(document.getElementById('T')?.value) || 0;
            const V = parseFloat(document.getElementById('V')?.value) || 0;

            let ci = 0.000;
            let statusText = "Ready for calculation.";
            let statusColor = "bg-gray-200 text-gray-700";

            try {
                // 1. Effective Capacity (C_Eff)
                const CEff = C * (1 - V);

                // 2. Total Required Effort (E_Total)
                // The formula uses V to account for effort consumed *due to* volatility handling.
                const ETotal = S * (1 + D) * (1 + T) * (1 + 0.5 * V);

                // 3. Final Coherence Index (CI)
                ci = 1 - (ETotal / CEff);
                
                // Status Logic
                if (ci > 0.050) {
                    statusText = "Resilient Zone (CI > 0.050). The system has significant capacity and is robust.";
                    statusColor = "bg-green-100 text-green-700";
                } else if (ci >= 0.00 && ci <= 0.050) {
                    statusText = "Critical Headroom (CI â‰ˆ 0.00). System is operating near the Coherence Loss Threshold (CLT). Risky.";
                    statusColor = "bg-yellow-100 text-yellow-700";
                } else if (ci < 0.00) {
                    statusText = "Technical Collapse (CI < 0.00). Required effort exceeds effective capacity. Structural failure is inevitable.";
                    statusColor = "bg-red-100 text-red-700";
                }

            } catch (e) {
                // Should not happen with current logic, but good for safety
                console.error("Calculation Error:", e);
                ci = 0.000;
                statusText = "Error during calculation. Check input values.";
                statusColor = "bg-red-100 text-red-700";
            }

            document.getElementById('ci-output').textContent = ci.toFixed(3);
            document.getElementById('ci-result-card').className = `bg-white p-6 rounded-xl shadow-2xl border-b-4 ${ci > 0.050 ? 'border-green-500' : (ci >= 0.00 ? 'border-yellow-500' : 'border-red-500')} transition-all duration-300`;
            
            const statusElement = document.getElementById('ci-status');
            statusElement.textContent = statusText;
            statusElement.className = `mt-4 text-center text-sm font-medium p-2 rounded-lg ${statusColor}`;
        }

        // --- Firebase Initialization and Auth ---

        async function initFirebase() {
            if (!firebaseConfig) {
                console.error("Firebase config is missing in the environment.");
                return;
            }

            try {
                // setLogLevel('debug'); // Uncomment for Firestore debugging
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Set up auth state listener
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                    } else {
                        // Use a random ID if anonymous sign-in fails
                        userId = crypto.randomUUID();
                    }
                    isAuthReady = true;
                    console.log(`Auth Ready. User ID: ${userId}`);

                    // Start listening for data submissions now that we are authenticated
                    if (isAuthReady) {
                        listenForSubmissions();
                    }
                });

                // Attempt to sign in with the provided token or anonymously
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

            } catch (error) {
                document.getElementById('message-box').textContent = `Firebase Error: ${error.message}. Data saving will fail.`;
                console.error("Firebase initialization failed:", error);
            }
        }


        // --- Firestore Data Submission ---

        async function submitData() {
            if (!isAuthReady || !db) {
                showMessage("Database connection not ready. Please wait a moment.", 'red');
                return;
            }

            const description = document.getElementById('project-description').value.trim();
            const S = parseFloat(document.getElementById('S')?.value) || 0;
            const D = parseFloat(document.getElementById('D')?.value) || 0;
            const T = parseFloat(document.getElementById('T')?.value) || 0;
            const V = parseFloat(document.getElementById('V')?.value) || 0;
            const ciOutput = document.getElementById('ci-output').textContent;
            const CI = parseFloat(ciOutput);

            if (!description) {
                showMessage("Please provide a Project Type/Description.", 'red');
                return;
            }

            const submissionData = {
                projectDescription: description,
                C: C, // Always 1.00
                S: S,
                D: D,
                T: T,
                V: V,
                CI: CI,
                submitterId: userId,
                timestamp: serverTimestamp()
            };

            try {
                const collectionPath = `artifacts/${appId}/public/data/cr90_submissions`;
                await addDoc(collection(db, collectionPath), submissionData);
                showMessage(`CR-90 data submitted successfully! CI: ${CI.toFixed(3)}`, 'green');
                // Optional: Clear form except for default inputs
                document.getElementById('project-description').value = '';

            } catch (e) {
                showMessage(`Failed to submit data: ${e.message}`, 'red');
                console.error("Error adding document: ", e);
            }
        }

        window.submitData = submitData; // Expose to global scope for button click

        // --- Firestore Real-time Listener (The "Repository") ---

        function listenForSubmissions() {
            const tableBody = document.getElementById('submissions-table-body');
            const collectionPath = `artifacts/${appId}/public/data/cr90_submissions`;
            const submissionsQuery = query(collection(db, collectionPath));

            onSnapshot(submissionsQuery, (snapshot) => {
                const submissions = [];
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    // Convert timestamp if it exists and is not null
                    let dateStr = 'Pending...';
                    if (data.timestamp && data.timestamp.toDate) {
                         const date = data.timestamp.toDate();
                         dateStr = date.toLocaleDateString('en-US', { month: 'numeric', day: 'numeric', hour: '2-digit', minute: '2-digit' });
                    }
                    submissions.push({
                        id: doc.id,
                        projectDescription: data.projectDescription || 'N/A',
                        CI: data.CI ? data.CI.toFixed(3) : 'N/A',
                        S: data.S ? data.S.toFixed(2) : 'N/A',
                        D: data.D ? data.D.toFixed(2) : 'N/A',
                        T: data.T ? data.T.toFixed(2) : 'N/A',
                        V: data.V ? data.V.toFixed(2) : 'N/A',
                        submitterId: data.submitterId || 'Anonymous',
                        timestamp: dateStr
                    });
                });

                // Sort by CI descending for better visibility, then by timestamp
                submissions.sort((a, b) => b.CI - a.CI);

                if (submissions.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="7" class="px-3 py-4 text-sm text-gray-500 text-center">No data submitted yet. Be the first!</td></tr>';
                } else {
                    tableBody.innerHTML = submissions.map(sub => `
                        <tr class="hover:bg-gray-50">
                            <td class="px-3 py-3 whitespace-nowrap text-sm font-medium text-gray-900">${sub.projectDescription}</td>
                            <td class="px-3 py-3 whitespace-nowrap text-sm font-bold ${sub.CI > 0.050 ? 'text-green-600' : (sub.CI >= 0.00 ? 'text-yellow-600' : 'text-red-600')}">${sub.CI}</td>
                            <td class="px-3 py-3 whitespace-nowrap text-sm text-gray-500">${sub.S}</td>
                            <td class="px-3 py-3 whitespace-nowrap text-sm text-gray-500">${sub.D}</td>
                            <td class="px-3 py-3 whitespace-nowrap text-sm text-gray-500">${sub.T}</td>
                            <td class="px-3 py-3 whitespace-nowrap text-sm text-gray-500">${sub.V}</td>
                            <td class="px-3 py-3 whitespace-nowrap text-xs text-gray-500">${sub.submitterId.substring(0, 8)}...</td>
                        </tr>
                    `).join('');
                }
            }, (error) => {
                tableBody.innerHTML = '<tr><td colspan="7" class="px-3 py-4 text-sm text-red-600 text-center">Error loading data. Check console.</td></tr>';
                console.error("Firestore snapshot error:", error);
            });
        }

        // --- Utility Functions ---

        function showMessage(text, type = 'blue') {
            const box = document.getElementById('message-box');
            box.textContent = text;
            box.className = `mt-4 text-center text-sm font-medium p-3 rounded-lg ${type === 'red' ? 'bg-red-100 text-red-700' : (type === 'green' ? 'bg-green-100 text-green-700' : 'bg-blue-100 text-blue-700')}`;
            setTimeout(() => {
                box.textContent = '';
                box.className = 'mt-4 text-center text-sm font-medium text-red-600';
            }, 5000);
        }

        // --- Initial Load ---

        window.onload = () => {
            renderInputs();
            initFirebase();
            updateCI(); // Initial calculation display
        };
    </script>
</body>
</html>